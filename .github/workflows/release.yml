name: build-test-release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-test-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run unit tests
        run: go test ./...

      - name: Build git-opener binary
        run: |
          mkdir -p dist
          go build -o dist/git-opener ./src

      - name: Determine release bump
        id: bump
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          if [[ -z "${COMMIT_MESSAGE}" ]]; then
            COMMIT_MESSAGE="$(git log -1 --pretty=%B)"
          fi

          if [[ "${COMMIT_MESSAGE}" == "!feat:"* ]]; then
            BUMP="major"
          elif [[ "${COMMIT_MESSAGE}" == "feat:"* ]]; then
            BUMP="minor"
          elif [[ "${COMMIT_MESSAGE}" == "fix:"* ]]; then
            BUMP="patch"
          else
            echo "No release bump keyword found. Skipping release."
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            printf "should_release=true\n"
            printf "bump=%s\n" "$BUMP"
            printf "release_notes<<'EOF'\n%s\nEOF\n" "$COMMIT_MESSAGE"
          } >> "$GITHUB_OUTPUT"

      - name: Compute next version
        id: version
        if: steps.bump.outputs.should_release == 'true'
        env:
          BUMP: ${{ steps.bump.outputs.bump }}
        run: |
          set -euo pipefail

          git fetch --tags --force
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')"
          VERSION="${LAST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          : "${MAJOR:=0}"
          : "${MINOR:=0}"
          : "${PATCH:=0}"

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unknown bump '$BUMP'" >&2
              exit 1
              ;;
          esac

          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "new_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"

      - name: Push git tag
        if: steps.bump.outputs.should_release == 'true'
        env:
          TAG_NAME: ${{ steps.version.outputs.new_tag }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Create GitHub release
        if: steps.bump.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: Release ${{ steps.version.outputs.new_tag }}
          body: ${{ steps.bump.outputs.release_notes }}
          files: dist/git-opener
